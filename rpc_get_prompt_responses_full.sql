CREATE OR REPLACE FUNCTION get_prompt_responses_by_sharer(sharer_id UUID) RETURNS JSON AS $$ DECLARE result JSON; BEGIN WITH prompt_data AS (SELECT pr.id, pr."promptId", pr."profileSharerId", pr.summary, pr."videoId", pr."responseNotes", v."muxPlaybackId", v."muxAssetId", vt.transcript FROM "PromptResponse" pr LEFT JOIN "Video" v ON pr."videoId" = v.id LEFT JOIN "VideoTranscript" vt ON v.id = vt."videoId" WHERE pr."profileSharerId" = sharer_id) SELECT COALESCE(json_agg(pd.*), '[]'::json) INTO result FROM prompt_data pd; RETURN result; END; $$ LANGUAGE plpgsql SECURITY DEFINER;
